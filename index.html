<!DOCTYPE html>
<html>

<head>
    <meta charset=UTF-8>
    <meta name=viewport content="width=device-width, initial-scale=1.0">
    <title>2022 Commonwealth Games Birmingham</title>

    <style>
        #map {
            width: 100%;
            height: 600px;
            border: thin solid #CCC;
        }

        #control-panel {
            background-color: #fff;
            margin-bottom: 50px;
        }

        .select-location-label {
            font-weight: bold;
            min-width: 40px;
            display: inline-block;
        }
    </style>

    <!-- Google Maps -->
    <script
        src=https://maps.googleapis.com/maps/api/js?key=AIzaSyCQRTMuRO4K1AyH9fFr6zH7Kd2qSwz3Wuk&libraries=places></script>

    <script>
        let directionsRenderer = null
        let map = null
        let placeType = null
        let services_centre_location = { lat: 52.489471, lng: -1.898575 }

        window.onload = () => {

            let url = `data.json`
            let locations = [];

            fetch(url)
                .then(response => response.json())
                .then(jsonData => {

                    locations = jsonData;


                    locations[0].venue.map(location => {
                        let marker = new google.maps.Marker({
                            position: new google.maps.LatLng(location.location[0], location.location[1]),
                            icon: { url: "markers/venue_marker.png", scaledSize: new google.maps.Size(40, 40) },
                            map: map,
                        })

                        google.maps.event.addListener(marker, "click", () => {
                            infoWindow.setContent(`<h1>${location.name}</h1>
                                <p>${location.description}</p>
                                <p>${location.address}</p>

                                ${location.sports.map(sport => `<p>${sport}</p>`).join('')}
                                <img src = ${location.url} />
                                `)

                            infoWindow.open(map, marker)
                        })


                    })

                    const sports = locations[0].venue.map(venue => venue.sports.map(sport => sport));
                    const uniqueSports = [...new Set(sports.flat())].sort();

                    // filter by sport - basic function
                    // locations[0].venue.filter(location => {
                    //     if (location.sports.includes(uniqueSports[2])) {
                    //         let marker = new google.maps.Marker({
                    //             position: new google.maps.LatLng(location.location[0], location.location[1]),
                    //             icon: { url: "markers/venue_marker.png", scaledSize: new google.maps.Size(40, 40) },
                    //             map: map,
                    //         })

                    //         google.maps.event.addListener(marker, "click", () => {
                    //             infoWindow.setContent(location.description)
                    //             infoWindow.open(map, marker)
                    //         })
                    //     }
                    // }
                    // )
                })

            new google.maps.places.Autocomplete(start);
            new google.maps.places.Autocomplete(end);

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: new google.maps.LatLng(52.489471, -1.898575),
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControlOptions: {
                    mapTypeIds: ["roadmap", "hide_poi"]
                }
            })

            hidePointsOfInterest(map)



            let service = new google.maps.places.PlacesService(map)


            directionsRenderer = new google.maps.DirectionsRenderer()
            directionsRenderer.setMap(map)

            calculateRoute()

        }

        let markers = []
        function getNearbyServicesMarkers(results, status) {
            markers.map(marker => marker.setVisible(false))
            markers = []
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                results.map(result => {
                    createMarker(result)
                })
            }
        }


        let infoWindow = new google.maps.InfoWindow()
        function createMarker(place) {
            let icon = {
                url: `markers/${place.types[0]}_marker.png`,
                scaledSize: new google.maps.Size(40, 40) // scale the image to an icon size
            }


            let marker = new google.maps.Marker({
                map: map,
                icon: icon,
                position: place.geometry.location
            })

            markers.push(marker)

            google.maps.event.addListener(marker, "click", () => {


                infoWindow.open(map, marker)
            })
        }

        function calculateRoute() {
            let start = document.getElementById("start").value
            let end = document.getElementById("end").value

            if (start === "" || end === "") {
                return
            }


            let request = {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode.DRIVING
            }

            directionsService = new google.maps.DirectionsService()
            directionsService.route(request, (route, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(route)
                }
            })
        }

        function hidePointsOfInterest(map) {
            let styles = [
                {
                    "featureType": "poi",
                    "stylers": [{ "visibility": "off" }]
                }
            ]

            let styledMapType = new google.maps.StyledMapType(styles, { name: "Hide POI", alt: "Hide Points of Interest" })
            map.mapTypes.set("hide_poi", styledMapType)

            map.setMapTypeId("hide_poi")
        }

        function displayMap() {
            service = new google.maps.places.PlacesService(map)
            service.nearbySearch({
                location: services_centre_location, // centre of the search
                radius: 500, // radius (in metres) of the search
                keyword: placeType // https://developers.google.com/maps/documentation/places/web-service/supported_types
            }, getNearbyServicesMarkers)
        }
    </script>
</head>

<body>
    <div id=control-panel>
        <span class=select-location-label>Start:</span>
        <input id="start">

        <br>
        <span class=select-location-label>End:</span>
        <input id="end">

        <button onclick="calculateRoute()">Submit</button>
    </div>

    <span onclick="placeType = 'restaurant'; displayMap()">Restaurant</span>
    <span onclick="placeType = 'bar'; displayMap()">Bar</span>
    <span onclick="placeType = 'hospital'; displayMap()">Hospital</span>

    <div id=map></div>
</body>

</html>